name: quisp main
on: [push, pull_request]
jobs:
  unit-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/sfc-aqua/quisp-ci:latest
      credentials:
        username: quisp-bot
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: work around permission issue
        run: git config --global --add safe.directory /__w/quisp/quisp
      - name: Check out repository
        uses: actions/checkout@v4
      - name: make eigen
        run: make eigen
      - name: generate makefile
        run: make makefile-lib
      - name: generate message headers
        run: make msgheaders
      - name: make googletest
        run: make googletest
      - name: unit tests and generate coverage report
        run: |
          opp_makemake -f --deep -O out -i ./makefrag -M release --make-so
          make lcov.info
          lcov -r lcov.info 'googletest/*' -o lcov_filtered.info
        working-directory: quisp
      - name: Coveralls
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./quisp/lcov_filtered.info
  simulation-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/sfc-aqua/quisp-ci:latest
      credentials:
        username: quisp-bot
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: work around permission issue
        run: git config --global --add safe.directory /__w/quisp/quisp
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Install python dependencies for simulation tests
        run: pip install -r requirements.txt
      - name: Verify qutip import path
        run: python3 scripts/check_qutip_import.py
      - name: Run qutip worker smoke checks
        run: python3 scripts/qutip_worker_smoke.py
      - name: doctest for simulation test utils
        run:  python3 -m doctest simulation_tests/utils.py -v
      - name: make eigen
        run: make eigen
      - name: build
        run: make exe
      - name: Run Simulations
        run: pytest simulation_tests -n auto
  module-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/sfc-aqua/quisp-ci:latest
      credentials:
        username: quisp-bot
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: work around permission issue
        run: git config --global --add safe.directory /__w/quisp/quisp
      - name: Check out repository
        uses: actions/checkout@v4
      - name: make eigen
        run: make eigen
      - name: generate makefile
        run: make makefile-lib
      - name: generate message headers
        run: make msgheaders
      - name: make googletest
        run: make googletest
      - name: Run logging observability audit
        run: |
          if rg -n "std::cout|std::cerr" quisp/modules/QRSA/RuleEngine quisp/runtime quisp/core/events quisp/modules/QRSA/ConnectionManager --glob '*.{cc,h,cxx,hpp}'; then
            echo "Unexpected std::cout/std::cerr usage found in logging scope"
            exit 1
          fi
          if rg -n "MIM Protocol v1 Link|MSM Protocol v1 Link" doc quisp/modules --glob '!**/term-audit.md'; then
            echo "Prohibited link/protocol naming mix detected"
            exit 1
          fi
          rg -n "runtime_error|runtime_uncaught_error|runtime_debug_state|runtime_debug_source|runtime_debug_qubit|runtime_debug_reg|unknown_rule_event|unknown_rule_protocol|connection_manager_unknown_control_message" quisp
          rg -n "protocol_spec|execution_path|protocol_raw_value|event_number|msg_name|msg_type" quisp/core/events quisp/modules/QRSA quisp/modules/Logger quisp/runtime
      - name: run module_tests
        run: make run-module-test
  clang-tidy:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/sfc-aqua/quisp-ci:latest
      credentials:
        username: quisp-bot
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: work around permission issue
        run: git config --global --add safe.directory /__w/quisp/quisp
      - name: Check out repository
        uses: actions/checkout@v4
      - name: make eigen
        run: make eigen
      - name: generate makefile
        run: make makefile-lib
      - name: generate message headers
        run: make msgheaders
      - name: make googletest
        run: make googletest
      - name: clang-tidy
        run: make tidy
  clang-format:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/sfc-aqua/quisp-ci:latest
      credentials:
        username: quisp-bot
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: work around permission issue
        run: git config --global --add safe.directory /__w/quisp/quisp
      - name: Check out repository
        uses: actions/checkout@v4
      - name: generate makefile
        run: make makefile-lib
      - name: generate message headers
        run: make msgheaders
      - name: clang-format
        run: make format-ci
